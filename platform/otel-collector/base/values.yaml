# OpenTelemetry Collector configuration
# DaemonSet mode to collect logs from all nodes
mode: daemonset

# Image configuration - contrib distribution
image:
  repository: otel/opentelemetry-collector-contrib

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

# Service configuration - enabled to allow applications to send traces
# In DaemonSet mode, service must be explicitly enabled
service:
  enabled: true
  type: ClusterIP

ports:
  otlp:
    enabled: true
    containerPort: 4317
    servicePort: 4317
    protocol: TCP
  otlp-http:
    enabled: true
    containerPort: 4318
    servicePort: 4318
    protocol: TCP
  prometheus:
    enabled: true
    containerPort: 8889
    servicePort: 8889
    protocol: TCP

# Presets for Kubernetes log collection
presets:
  logsCollection:
    enabled: true
    includeCollectorLogs: false
  kubernetesAttributes:
    enabled: true
    extractAllPodLabels: true
    extractAllPodAnnotations: false

# Collector configuration
config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
    
    # Prometheus receiver for self-monitoring
    prometheus:
      config:
        scrape_configs:
          - job_name: otel-collector
            scrape_interval: 30s
            static_configs:
              - targets:
                  - localhost:8888

  processors:
    batch:
      timeout: 10s
      send_batch_size: 1024
      send_batch_max_size: 2048
    
    memory_limiter:
      check_interval: 1s
      limit_mib: 400
      spike_limit_mib: 100
    
    # Add resource attributes
    resource:
      attributes:
        - key: cluster
          value: "dev"
          action: upsert
    
    # 从 K8s 元数据推断 service.name，解决 unknown_service 问题
    transform/service_name:
      error_mode: ignore
      log_statements:
        - context: resource
          statements:
            # 如果 service.name 缺失或为 unknown_service，从 k8s.deployment.name 推断
            - set(attributes["service.name"], attributes["k8s.deployment.name"]) where attributes["service.name"] == nil
            - set(attributes["service.name"], attributes["k8s.deployment.name"]) where IsMatch(attributes["service.name"], "^unknown_service.*")
      metric_statements:
        - context: resource
          statements:
            - set(attributes["service.name"], attributes["k8s.deployment.name"]) where attributes["service.name"] == nil
            - set(attributes["service.name"], attributes["k8s.deployment.name"]) where IsMatch(attributes["service.name"], "^unknown_service.*")
      trace_statements:
        - context: resource
          statements:
            - set(attributes["service.name"], attributes["k8s.deployment.name"]) where attributes["service.name"] == nil
            - set(attributes["service.name"], attributes["k8s.deployment.name"]) where IsMatch(attributes["service.name"], "^unknown_service.*")

  exporters:
    # Prometheus remote write for metrics (cross-namespace)
    prometheusremotewrite:
      endpoint: "http://prometheus-prometheus.prometheus.svc:9090/api/v1/write"
      tls:
        insecure: true
    
    # Loki for logs via OTLP HTTP (Loki 3.x native OTLP support)
    otlphttp/loki:
      endpoint: "http://loki.loki.svc:3100/otlp"
      tls:
        insecure: true
    
    # Tempo for traces (cross-namespace)
    otlp/tempo:
      endpoint: "http://tempo.tempo.svc:4317"
      tls:
        insecure: true
    
    # Debug exporter (for development)
    debug:
      verbosity: basic

  extensions:
    health_check:
      endpoint: 0.0.0.0:13133
    
    pprof:
      endpoint: 0.0.0.0:1777
    
    zpages:
      endpoint: 0.0.0.0:55679

  service:
    extensions:
      - health_check
      - pprof
      - zpages
    
    pipelines:
      traces:
        receivers:
          - otlp
        processors:
          - memory_limiter
          - transform/service_name
          - batch
          - resource
        exporters:
          - otlp/tempo
      
      metrics:
        receivers:
          - otlp
          - prometheus
        processors:
          - memory_limiter
          - transform/service_name
          - batch
          - resource
        exporters:
          - prometheusremotewrite
      
      logs:
        receivers:
          - otlp
          - filelog  # Collect container logs via logsCollection preset
        processors:
          - memory_limiter
          - transform/service_name
          - batch
        exporters:
          - otlphttp/loki

# Tolerations to run on all nodes
tolerations:
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# ServiceMonitor for Prometheus
serviceMonitor:
  enabled: true
  metricsEndpoints:
    - port: prometheus
