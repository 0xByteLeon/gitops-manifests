# Production environment Prometheus values
alertmanager:
  alertmanagerSpec:
    replicas: 3
    
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi
    
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: "fast-ssd"
          resources:
            requests:
              storage: 20Gi
    
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - alertmanager
              topologyKey: kubernetes.io/hostname
  
  config:
    global:
      resolve_timeout: 5m
      slack_api_url: ''  # Set via secret
    
    route:
      group_by: ['alertname', 'namespace', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default-receiver'
      routes:
        - match:
            severity: critical
          receiver: 'critical-receiver'
          continue: true
        - match:
            severity: warning
          receiver: 'warning-receiver'
    
    receivers:
      - name: 'default-receiver'
        slack_configs:
          - channel: '#prod-alerts'
            send_resolved: true
      
      - name: 'critical-receiver'
        slack_configs:
          - channel: '#prod-critical'
            send_resolved: true
        pagerduty_configs:
          - service_key: ''  # Set via secret
            severity: critical
      
      - name: 'warning-receiver'
        slack_configs:
          - channel: '#prod-warnings'
            send_resolved: true

prometheus:
  prometheusSpec:
    replicas: 3
    retention: 30d
    retentionSize: "100GB"
    
    resources:
      limits:
        cpu: 4000m
        memory: 8Gi
      requests:
        cpu: 1000m
        memory: 4Gi
    
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: "fast-ssd"
          resources:
            requests:
              storage: 200Gi
    
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - prometheus
              topologyKey: kubernetes.io/hostname
    
    # Thanos sidecar for long-term storage (optional)
    # thanos:
    #   objectStorageConfig:
    #     name: thanos-objstore-config
    #     key: objstore.yml

# Production alerting rules
additionalPrometheusRulesMap:
  production-rules:
    groups:
      - name: production-alerts
        rules:
          - alert: HighMemoryUsage
            expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High memory usage detected"
              description: "Memory usage is above 90% on {{ $labels.instance }}"
          
          - alert: HighCPUUsage
            expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High CPU usage detected"
              description: "CPU usage is above 90% on {{ $labels.instance }}"
          
          - alert: PodCrashLooping
            expr: rate(kube_pod_container_status_restarts_total[15m]) * 60 * 15 > 3
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Pod is crash looping"
              description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"

